---
- name: Bootstrap
  connection: local
  gather_facts: false
  hosts: all
  vars:
    ansible_python_interpreter: /usr/bin/python3
  become: true
  tasks:

   - name: Update APT
     apt:
      update_cache: yes

   - name: Upgrade APT
     apt:
      upgrade: "yes"
      update_cache: true
      cache_valid_time: 172800 # Two days

   - name: Installs Node Source
     shell: |
      curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -
     args:
      warn: false

   - name: Common Dependencies
     apt:
      pkg:
       - apt-transport-https=1.6.12ubuntu0.1
       - ca-certificates=20190110~18.04.1
       - curl=7.58.0-2ubuntu3.9
       - gnupg-agent=2.2.4-1ubuntu1.2
       - gnupg2=2.2.4-1ubuntu1.2
       - pass=1.7.1-3
       - software-properties-common=0.96.24.32.13
       - unzip=6.0-21ubuntu1
       - tree=1.7.0-5
       - iptables-persistent=1.0.4+nmu2ubuntu1
       - nmap=7.60-1ubuntu5
       - rpm=4.14.1+dfsg1-2
       - apache2-utils=2.4.29-1ubuntu4.13
       - libnss3-tools=2:3.35-2ubuntu2.9
       - ruby=1:2.5.1
       - ruby-dev=1:2.5.1
       - gcc=4:7.4.0-1ubuntu2.3
       - g++=4:7.4.0-1ubuntu2.3
       - make=4.1-9.1ubuntu1
       - nginx=1.14.0-0ubuntu1.7
       - nodejs=10.22.0-1nodesource1
       - python3.8=3.8.0-3~18.04
       - python3-distutils=3.6.9-1~18.04
       - python3.8-venv=3.8.0-3~18.04
       - python3.8-dev=3.8.0-3~18.04
      state: present

   - name: Install MkCert
     get_url:
      url: https://github.com/FiloSottile/mkcert/releases/download/v1.4.1/mkcert-v1.4.1-linux-amd64
      dest: /usr/local/bin/mkcert
      mode: '0775'

   - name: Install PIP
     apt:
      name: python3-pip=9.0.1-2.3~ubuntu1.18.04.1

   - name: "Pip Upgrade"
     command: python3.8 -m pip install --upgrade pip setuptools wheel

   - name: Install Setuptools
     pip:
      name: pip install setuptools==49.2.0

  # Adds time to sync to Cloudflare time
  # https://www.cloudflare.com/time/
   - name: "Add Cloudflare Time"
     copy:
      remote_src: yes
      src: ./files/timesyncd.conf
      dest: /etc/systemd/timesyncd.conf

   - name: "Set NTP On"
     command: timedatectl set-ntp true

   - name: "Time Sync Config"
     systemd:
      name: systemd-timesyncd.service
      state: restarted
      daemon_reload: yes
      enabled: yes

   - name: Clean Packages
     apt:
      autoremove: yes
      purge: yes

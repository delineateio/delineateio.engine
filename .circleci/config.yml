version: 2.1

parameters:
  terraform-image:
    type: string
    default: "hashicorp/terraform:0.12.28"
  gcloud-image:
    type: string
    default: "google/cloud-sdk:300.0.0-alpine"
  ruby-image:
    type: string
    default: "circleci/ruby:2.5.1"
  inspec-version:
    type: string
    default: "4.21.3"

commands:
  set_branch:
    steps:
      - run:
          name: Configure for Branch
          command: bash ./.circleci/branch.sh
  gcp_key:
    steps:
      - run:
          name: "Add GCP Key"
          command: source ~/.env && echo $GOOGLE_CREDENTIALS > /tmp/gcp.json
  add_bash:
    steps:
      - run:
          name: Install Bash
          command: apk add bash
  gcp_update:
    steps:
      - run:
          name: Update Infrastructure
          command: |
            source ~/.env
            cd ./ops/infra
            terraform init -backend-config="bucket=${GOOGLE_PROJECT}-tf"
            terraform plan -var-file="./env/${DELINEATEIO_ENV}.tfvars" -lock=true -refresh=true -out=plan.out
            terraform apply -lock=true -refresh=true -auto-approve plan.out

jobs:
  build_infrastructure:
    docker:
      - image: << pipeline.parameters.terraform-image >>
    environment:
      BASH_ENV: "~/.bash_profile"
    steps:
      - add_bash
      - checkout
      - set_branch
      - gcp_key
      - gcp_update

  test_infrastructure:
    docker:
      - image: << pipeline.parameters.ruby-image >>
    steps:
      - checkout
      - set_branch
      - gcp_key
      - run:
          name: Install InSpec
          command: gem install inspec-bin -v << pipeline.parameters.inspec-version >>
      - run:
          name: Run InSpec
          command: |
            source ~/.env
            cd ./ops/tests
            inspec exec . -t gcp:// --chef-license=accept-no-persist --input gcp_project_id=$GOOGLE_PROJECT

  deploy_app:
    docker:
      - image: << pipeline.parameters.gcloud-image >>
    steps:
      - checkout
      - setup_remote_docker
      - set_branch
      - gcp_key
      - run:
          name: Install GCP Components
          command: gcloud components install kubectl skaffold --quiet
      - run:
          name: Install Container Structure Test
          command: curl -LO https://storage.googleapis.com/container-structure-test/latest/container-structure-test-linux-amd64 && chmod +x container-structure-test-linux-amd64 && mv container-structure-test-linux-amd64 /usr/local/bin/container-structure-test
      - run:
          name: Set GCP Project
          command: source ~/.env && gcloud config set project $GOOGLE_PROJECT
      - run:
          name: Authenticate GCP Service Account
          command: gcloud auth activate-service-account --key-file=/tmp/gcp.json
      - run:
          name: Add GKE Config
          command: source ~/.env && gcloud container clusters get-credentials app-cluster -z $GOOGLE_ZONE
      - run:
          name: Deploy to GKE
          command: |
            source ~/.env
            cd ./dev/services/customers
            skaffold run -p "pub" -d "$GOOGLE_REGISTRY/$GOOGLE_PROJECT"

  configure_ingress:
    docker:
      - image: << pipeline.parameters.terraform-image >>
    steps:
      - add_bash
      - checkout
      - set_branch
      - run:
          name: Initialise Terraform
          command: source ~/.env && cd ./ops/ingress && terraform init -backend-config="bucket=${GOOGLE_PROJECT}-tf"
      - run:
          name: Plan Ingress
          command: source ~/.env && cd ./ops/ingress && terraform plan -lock=true -refresh=true -out=plan.out
      - run:
          name: Apply Ingress
          command: source ~/.env && cd ./ops/ingress && terraform apply -lock=true -refresh=true -auto-approve plan.out

workflows:
  version: 2
  run:
    jobs:
      - build_infrastructure
      - test_infrastructure:
          requires:
            - build_infrastructure
      - deploy_app:
          requires:
            - build_infrastructure
      - configure_ingress:
          requires:
            - test_infrastructure
            - deploy_app

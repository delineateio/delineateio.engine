version: 2.1

parameters:
  terraform-image:
    type: string
    default: "hashicorp/terraform:0.12.29"
  gcloud-image:
    type: string
    default: "google/cloud-sdk:302.0.0-alpine"
  ruby-image:
    type: string
    default: "circleci/ruby:2.5.1"
  inspec-version:
    type: string
    default: "4.21.3"

commands:
  set_branch:
    steps:
      - run:
          name: Configure for Branch
          command: bash ./.circleci/branch.sh
  gcp_key:
    steps:
      - run:
          name: "Add GCP Key"
          command: source ~/.env && echo $GOOGLE_CREDENTIALS > /tmp/gcp.json
  add_bash:
    steps:
      - run:
          name: Install Bash
          command: apk add bash
  gcp_apply:
    parameters:
      dir:
        type: string
    steps:
      - run:
          name: Apply Infrastructure
          command: |
            source ~/.env
            cd << parameters.dir >>
            terraform init -backend-config="bucket=${GOOGLE_PROJECT}-tf"
            terraform plan -var-file="../env/${DELINEATEIO_ENV}.tfvars" \
                              -lock=true -refresh=true -out=plan.out
            terraform apply -lock=true -refresh=true -auto-approve plan.out
  deploy_component:
    parameters:
      component_type:
        type: string
      component_name:
        type: string
    steps:
      - run:
          name: Update Git Submodules
          command: git submodule update --init --recursive
      - run:
          name: Set GCP Project
          command: source ~/.env && gcloud config set project $GOOGLE_PROJECT
      - run:
          name: Authenticate GCP Service Account
          command: gcloud auth activate-service-account --key-file=/tmp/gcp.json
      - run:
          name: Compare Last Deployment
          command: source ~/.env && bash ./.circleci/deploy_check.sh << parameters.component_type >> << parameters.component_name >>
      - run:
          name: Install GCP Components
          command: gcloud components install kubectl skaffold --quiet
      - run:
          name: Install Container Structure Test
          command: curl -LO https://storage.googleapis.com/container-structure-test/latest/container-structure-test-linux-amd64 && chmod +x container-structure-test-linux-amd64 && mv container-structure-test-linux-amd64 /usr/local/bin/container-structure-test
      - run:
          name: Add GKE Config
          command: source ~/.env && gcloud container clusters get-credentials app-cluster -z $GOOGLE_ZONE
      - run:
          name: Deploy to GKE
          command: |
            source ~/.env
            cd ./dev/<< parameters.component_type >>/<< parameters.component_name >>
            skaffold run -p "pub" -d "$GOOGLE_REGISTRY/$GOOGLE_PROJECT"
      - run:
          name: Add New Deployment
          command: source ~/.env && bash ./.circleci/deploy_add.sh << parameters.component_type >> << parameters.component_name >>
  gcp_destroy:
    parameters:
      dir:
        type: string
    steps:
      - run:
          name: Destroy
          command: |
            source ~/.env
            cd << parameters.dir >>
            terraform init -backend-config="bucket=${GOOGLE_PROJECT}-tf"
            terraform destroy -var-file="../env/${DELINEATEIO_ENV}.tfvars" -auto-approve

jobs:
  apply_network:
    docker:
      - image: << pipeline.parameters.terraform-image >>
    environment:
      BASH_ENV: "~/.bash_profile"
    steps:
      - add_bash
      - checkout
      - set_branch
      - gcp_key
      - gcp_apply:
          dir: ./ops/network

  apply_cluster:
    docker:
      - image: << pipeline.parameters.terraform-image >>
    environment:
      BASH_ENV: "~/.bash_profile"
    steps:
      - add_bash
      - checkout
      - set_branch
      - gcp_key
      - gcp_apply:
          dir: ./ops/cluster

  test_infrastructure:
    docker:
      - image: << pipeline.parameters.ruby-image >>
    steps:
      - checkout
      - set_branch
      - gcp_key
      - run:
          name: Install InSpec
          command: gem install inspec-bin -v << pipeline.parameters.inspec-version >>
      - run:
          name: Run InSpec
          command: |
            source ~/.env
            cd ./ops/tests
            inspec exec . -t gcp:// --chef-license=accept-no-persist --input gcp_project_id=$GOOGLE_PROJECT

  deploy_app:
    docker:
      - image: << pipeline.parameters.gcloud-image >>
    steps:
      - checkout
      - setup_remote_docker
      - set_branch
      - gcp_key
      - deploy_component:
          component_type: "services"
          component_name: "customers"

  apply_ingress:
    docker:
      - image: << pipeline.parameters.terraform-image >>
    steps:
      - add_bash
      - checkout
      - set_branch
      - gcp_apply:
          dir: ./ops/ingress

  destroy:
    docker:
      - image: << pipeline.parameters.terraform-image >>
    steps:
      - add_bash
      - checkout
      - set_branch
      - gcp_destroy:
          dir: ./ops/ingress
      - gcp_destroy:
          dir: ./ops/cluster

workflows:
  version: 2
  up:
    jobs:
      - apply_network
      - apply_cluster:
          requires:
            - apply_network
      - test_infrastructure:
          requires:
            - apply_cluster
      - deploy_app:
          requires:
            - apply_cluster
      - apply_ingress:
          requires:
            - test_infrastructure
            - deploy_app
  down:
    triggers:
      - schedule:
          cron: "0 1,4,7,10,13,16,19,22 * * *"
          filters:
            branches:
              ignore: "master"
    jobs:
      - destroy

    # This is where scheduled job goes
